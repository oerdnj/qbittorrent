From 6ca3e4f094da0a0017cb2d483ec1db6176bb0b16 Mon Sep 17 00:00:00 2001
From: Chocobo1 <Chocobo1@users.noreply.github.com>
Date: Sat, 11 Feb 2017 14:04:06 +0800
Subject: [PATCH] Add Utils::String::toHtmlEscaped
Debian-Bug: https://bugs.debian.org/856977

---
 src/base/logger.cpp                     | 5 +++--
 src/base/utils/string.cpp               | 9 +++++++++
 src/base/utils/string.h                 | 2 ++
 src/gui/deletionconfirmationdlg.h       | 5 +++--
 src/gui/properties/peerlistwidget.cpp   | 4 ++--
 src/gui/properties/propertieswidget.cpp | 4 ++--
 6 files changed, 21 insertions(+), 8 deletions(-)

Index: qbittorrent/src/base/logger.cpp
===================================================================
--- qbittorrent.orig/src/base/logger.cpp	2017-03-12 20:19:53.104168693 -0400
+++ qbittorrent/src/base/logger.cpp	2017-03-12 20:19:53.064167915 -0400
@@ -1,6 +1,7 @@
 #include "logger.h"
 
 #include <QDateTime>
+#include "base/utils/string.h"
 
 Logger* Logger::m_instance = 0;
 
@@ -36,7 +37,7 @@
 {
     QWriteLocker locker(&lock);
 
-    Log::Msg temp = { msgCounter++, QDateTime::currentMSecsSinceEpoch(), type, message };
+    Log::Msg temp = { msgCounter++, QDateTime::currentMSecsSinceEpoch(), type, Utils::String::toHtmlEscaped(message) };
     m_messages.push_back(temp);
 
     if (m_messages.size() >= MAX_LOG_MESSAGES)
@@ -49,7 +50,7 @@
 {
     QWriteLocker locker(&lock);
 
-    Log::Peer temp = { peerCounter++, QDateTime::currentMSecsSinceEpoch(), ip, blocked, reason };
+    Log::Peer temp = { peerCounter++, QDateTime::currentMSecsSinceEpoch(), Utils::String::toHtmlEscaped(ip), blocked, Utils::String::toHtmlEscaped(reason) };
     m_peers.push_back(temp);
 
     if (m_peers.size() >= MAX_LOG_MESSAGES)
Index: qbittorrent/src/base/utils/string.cpp
===================================================================
--- qbittorrent.orig/src/base/utils/string.cpp	2017-03-12 20:19:53.104168693 -0400
+++ qbittorrent/src/base/utils/string.cpp	2017-03-12 20:19:53.076168148 -0400
@@ -207,3 +207,12 @@
 
     return (diff == 0);
 }
+
+QString Utils::String::toHtmlEscaped(const QString &str)
+{
+#ifdef QBT_USES_QT5
+    return str.toHtmlEscaped();
+#else
+    return Qt::escape(str);
+#endif
+}
Index: qbittorrent/src/base/utils/string.h
===================================================================
--- qbittorrent.orig/src/base/utils/string.h	2017-03-12 20:19:53.104168693 -0400
+++ qbittorrent/src/base/utils/string.h	2017-03-12 20:19:53.080168226 -0400
@@ -47,6 +47,8 @@
         // Taken from https://crackstation.net/hashing-security.htm
         bool slowEquals(const QByteArray &a, const QByteArray &b);
 
+        QString toHtmlEscaped(const QString &str);
+
         bool naturalCompareCaseSensitive(const QString &left, const QString &right);
         bool naturalCompareCaseInsensitive(const QString &left, const QString &right);
     }
Index: qbittorrent/src/gui/deletionconfirmationdlg.h
===================================================================
--- qbittorrent.orig/src/gui/deletionconfirmationdlg.h	2017-03-12 20:19:53.104168693 -0400
+++ qbittorrent/src/gui/deletionconfirmationdlg.h	2017-03-12 20:19:53.084168304 -0400
@@ -35,8 +35,9 @@
 #include <QPushButton>
 #include "ui_confirmdeletiondlg.h"
 #include "base/preferences.h"
-#include "guiiconprovider.h"
 #include "base/utils/misc.h"
+#include "base/utils/string.h"
+#include "guiiconprovider.h"
 
 class DeletionConfirmationDlg : public QDialog, private Ui::confirmDeletionDlg {
   Q_OBJECT
@@ -45,7 +46,7 @@
   DeletionConfirmationDlg(QWidget *parent, const int &size, const QString &name, bool defaultDeleteFiles): QDialog(parent) {
     setupUi(this);
     if (size == 1)
-      label->setText(tr("Are you sure you want to delete '%1' from the transfer list?", "Are you sure you want to delete 'ubuntu-linux-iso' from the transfer list?").arg(name));
+      label->setText(tr("Are you sure you want to delete '%1' from the transfer list?", "Are you sure you want to delete 'ubuntu-linux-iso' from the transfer list?").arg(Utils::String::toHtmlEscaped(name)));
     else
       label->setText(tr("Are you sure you want to delete these %1 torrents from the transfer list?", "Are you sure you want to delete these 5 torrents from the transfer list?").arg(QString::number(size)));
     // Icons
Index: qbittorrent/src/gui/properties/peerlistwidget.cpp
===================================================================
--- qbittorrent.orig/src/gui/properties/peerlistwidget.cpp	2017-03-12 20:19:53.104168693 -0400
+++ qbittorrent/src/gui/properties/peerlistwidget.cpp	2017-03-12 20:19:53.096168538 -0400
@@ -392,7 +392,7 @@
     m_listModel->setData(m_listModel->index(row, PeerListDelegate::CONNECTION), peer.connectionType());
     m_listModel->setData(m_listModel->index(row, PeerListDelegate::FLAGS), peer.flags());
     m_listModel->setData(m_listModel->index(row, PeerListDelegate::FLAGS), peer.flagsDescription(), Qt::ToolTipRole);
-    m_listModel->setData(m_listModel->index(row, PeerListDelegate::CLIENT), peer.client());
+    m_listModel->setData(m_listModel->index(row, PeerListDelegate::CLIENT), Utils::String::toHtmlEscaped(peer.client()));
     m_listModel->setData(m_listModel->index(row, PeerListDelegate::PROGRESS), peer.progress());
     m_listModel->setData(m_listModel->index(row, PeerListDelegate::DOWN_SPEED), peer.payloadDownSpeed());
     m_listModel->setData(m_listModel->index(row, PeerListDelegate::UP_SPEED), peer.payloadUpSpeed());
@@ -423,7 +423,7 @@
     m_listModel->setData(m_listModel->index(row, PeerListDelegate::PORT), peer.address().port);
     m_listModel->setData(m_listModel->index(row, PeerListDelegate::FLAGS), peer.flags());
     m_listModel->setData(m_listModel->index(row, PeerListDelegate::FLAGS), peer.flagsDescription(), Qt::ToolTipRole);
-    m_listModel->setData(m_listModel->index(row, PeerListDelegate::CLIENT), peer.client());
+    m_listModel->setData(m_listModel->index(row, PeerListDelegate::CLIENT), Utils::String::toHtmlEscaped(peer.client()));
     m_listModel->setData(m_listModel->index(row, PeerListDelegate::PROGRESS), peer.progress());
     m_listModel->setData(m_listModel->index(row, PeerListDelegate::DOWN_SPEED), peer.payloadDownSpeed());
     m_listModel->setData(m_listModel->index(row, PeerListDelegate::UP_SPEED), peer.payloadUpSpeed());
Index: qbittorrent/src/gui/properties/propertieswidget.cpp
===================================================================
--- qbittorrent.orig/src/gui/properties/propertieswidget.cpp	2017-03-12 20:19:53.104168693 -0400
+++ qbittorrent/src/gui/properties/propertieswidget.cpp	2017-03-12 20:19:53.096168538 -0400
@@ -314,12 +314,12 @@
         label_total_size_val->setText(Utils::Misc::friendlyUnit(m_torrent->totalSize()));
 
         // Comment
-        comment_text->setText(Utils::Misc::parseHtmlLinks(m_torrent->comment()));
+        comment_text->setText(Utils::Misc::parseHtmlLinks(Utils::String::toHtmlEscaped(m_torrent->comment())));
 
         // URL seeds
         loadUrlSeeds();
 
-        label_created_by_val->setText(m_torrent->creator());
+        label_created_by_val->setText(Utils::String::toHtmlEscaped(m_torrent->creator()));
 
         // List files in torrent
         PropListModel->model()->setupModelData(m_torrent->info());
